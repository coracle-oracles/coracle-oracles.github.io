{% extends 'core/base.html' %}

{% block title %}Shifts - Coracle{% endblock %}

{% block head_content %}
<h1>Volunteer Shifts</h1>
<span class="subheading">Sign up to help at {{ event.name }}</span>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12">
        {% if not roles %}
            <div class="alert alert-info">No volunteer roles have been set up yet.</div>
        {% elif not grid %}
            <div class="alert alert-info">No shifts have been scheduled yet.</div>
        {% else %}
            {% if not has_ticket %}
            <div class="alert alert-warning">
                You must have a ticket to sign up for shifts. <a href="{% url 'tickets' %}">Get tickets</a>
            </div>
            {% elif event.max_shifts_per_user > 0 %}
            <div class="alert alert-info">
                You are signed up for {{ user_shift_count }} of {{ event.max_shifts_per_user }} allowed shifts.
            </div>
            {% endif %}
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th style="min-width: 100px;">Time</th>
                            {% for role in roles %}
                            <th style="min-width: 150px;">
                                {{ role.name }}
                                {% if role.description %}
                                <br><small class="text-muted">{{ role.description }}</small>
                                {% endif %}
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in grid %}
                        <tr>
                            <td class="table-light fw-bold text-nowrap">
                                {{ row.hour|date:"D, M j" }}<br>
                                <small>{{ row.hour|time:"g A" }}</small>
                            </td>
                            {% for cell in row.cells %}
                                {% if cell.type == 'empty' %}
                                    <td class="bg-light"></td>
                                {% elif cell.type == 'shift_start' %}
                                    <td rowspan="{{ cell.rowspan }}" class="align-middle text-center {% if cell.is_signed_up %}table-success{% endif %}">
                                        <div class="mb-2">
                                            <strong>{{ cell.shift.start_time|time:"g:i A" }} - {{ cell.shift.end_time|time:"g:i A" }}</strong>
                                        </div>
                                        <div class="mb-2">
                                            <span class="badge {% if cell.shift.spots_remaining > 0 %}bg-secondary{% else %}bg-danger{% endif %}">
                                                {{ cell.shift.spots_remaining }}/{{ cell.shift.capacity }} spots
                                            </span>
                                        </div>
                                        {% if cell.shift.assignments.all %}
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                {% for assignment in cell.shift.assignments.all %}
                                                    {{ assignment.user.name|default:assignment.user.email }}{% if not forloop.last %}, {% endif %}
                                                {% endfor %}
                                            </small>
                                        </div>
                                        {% endif %}
                                        {% if cell.is_signed_up %}
                                            <form method="post" action="{% url 'shift_cancel' cell.shift.id %}">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-outline-danger btn-sm">Cancel</button>
                                            </form>
                                        {% elif cell.shift.spots_remaining > 0 and has_ticket and can_signup_more %}
                                            <form method="post" action="{% url 'shift_signup' cell.shift.id %}">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-primary btn-sm">Sign Up</button>
                                            </form>
                                        {% elif cell.shift.spots_remaining == 0 %}
                                            <span class="text-muted">Full</span>
                                        {% endif %}
                                    </td>
                                {% endif %}
                                {# shift_continue cells are skipped due to rowspan #}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="mt-4">
                <h5>Your Shifts</h5>
                {% with user_shifts=request.user.shift_assignments.all %}
                    {% if user_shifts %}
                        <ul class="list-group">
                            {% for assignment in user_shifts %}
                                {% if assignment.shift.role.event == event %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ assignment.shift.role.name }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            {{ assignment.shift.start_time|date:"D, M d" }} &middot;
                                            {{ assignment.shift.start_time|time:"g:i A" }} - {{ assignment.shift.end_time|time:"g:i A" }}
                                        </small>
                                    </div>
                                    <form method="post" action="{% url 'shift_cancel' assignment.shift.id %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-outline-danger btn-sm">Cancel</button>
                                    </form>
                                </li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">You haven't signed up for any shifts yet.</p>
                    {% endif %}
                {% endwith %}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
